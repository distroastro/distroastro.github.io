#!/bin/sh

dir=$(dirname "$(readlink -f -- "$0")")
. "$dir/include.sh"

MJD="${mjdtime?}"

#*   ARGUMENTS (ξi)       AMP    PERIOD
#*  i  l  l' F  D  Ω       Ai      DAYS
#%  1  1  0  2  2  2    -0.024     5.64
#%  2  2  0  2  0  1    -0.040     6.85
#%  3  2  0  2  0  2    -0.099     6.86
#%  4  0  0  2  2  1    -0.051     7.09
#%  5  0  0  2  2  2    -0.123     7.10
#%  6  1  0  2  0  0    -0.039     9.11
#%  7  1  0  2  0  1    -0.411     9.12
#%  8  1  0  2  0  2    -0.993     9.13
#%  9  3  0  0  0  0    -0.018     9.18
#% 10 -1  0  2  2  1    -0.082     9.54
#% 11 -1  0  2  2  2    -0.197     9.56
#% 12  1  0  0  2  0    -0.076     9.61
#% 13  2  0  2 -2  2     0.022    12.81
#% 14  0  1  2  0  2     0.025    13.17
#% 15  0  0  2  0  0    -0.299    13.61
#% 16  0  0  2  0  1    -3.208    13.63
#% 17  0  0  2  0  2    -7.757    13.66
#% 18  2  0  0  0 -1     0.022    13.75
#% 19  2  0  0  0  0    -0.338    13.78
#% 20  2  0  0  0  1     0.018    13.81
#% 21  0 -1  2  0  2    -0.024    14.19
#% 22  0  0  0  2 -1     0.047    14.73
#% 23  0  0  0  2  0    -0.734    14.77
#% 24  0  0  0  2  1    -0.053    14.80
#% 25  0 -1  0  2  0    -0.051    15.39
#% 26  1  0  2 -2  1     0.050    23.86
#% 27  1  0  2 -2  2     0.101    23.94
#% 28  1  1  0  0  0     0.039    25.62
#% 29 -1  0  2  0  0     0.047    26.88
#% 30 -1  0  2  0  1     0.177    26.98
#% 31 -1  0  2  0  2     0.435    27.09
#% 32  1  0  0  0 -1     0.534    27.44
#% 33  1  0  0  0  0    -8.261    27.56
#% 34  1  0  0  0  1     0.544    27.67
#% 35  0  0  0  1  0     0.047    29.53
#% 36  1 -1  0  0  0    -0.055    29.80
#% 37 -1  0  0  2 -1     0.118    31.66
#% 38 -1  0  0  2  0    -1.824    31.81
#% 39 -1  0  0  2  1     0.132    31.96
#% 40  1  0 -2  2 -1     0.018    32.61
#% 41 -1 -1  0  2  0    -0.086    34.85
#% 42  0  2  2 -2  2    -0.057    91.31
#% 43  0  1  2 -2  1     0.033   119.61
#% 44  0  1  2 -2  2    -1.885   121.75
#% 45  0  0  2 -2  0     0.251   173.31
#% 46  0  0  2 -2  1     1.170   177.84
#% 47  0  0  2 -2  2   -48.247   182.62
#% 48  0  2  0  0  0    -0.194   182.63
#% 49  2  0  0 -2 -1     0.049   199.84
#% 50  2  0  0 -2  0    -0.547   205.89
#% 51  2  0  0 -2  1     0.037   212.32
#% 52  0 -1  2 -2  1    -0.045   346.60
#% 53  0  1  0  0 -1     0.092   346.64
#% 54  0 -1  2 -2  2     0.828   365.22
#% 55  0  1  0  0  0   -15.359   365.26
#% 56  0  1  0  0  1    -0.138   386.00
#% 57  1  0  0 -1  0     0.035   411.78
#% 58  2  0 -2  0  0    -0.137  1095.17
#% 59 -2  0  2  0  1     0.422  1305.47
#% 60 -1  1  0  1  0     0.040  3232.85
#% 61  0  0  0  0  2     7.900 -3399.18
#% 62  0  0  0  0  1 -1617.268 -6790.36

# Delaunay arguments
# l  = 134.96 + 13.064993 * (MJD - 51544.5) = Mean anomaly of the moon
# l' = 357.53 +  0.985600 * (MJD - 51544.5) = Mean anomaly of the sun
# F  =  93.27 + 13.229350 * (MJD - 51544.5) = L - Ω  where L = Mean longitude of the moon
# D  = 297.85 + 12.190749 * (MJD - 51544.5) = Mean elongation of the Moon from the sun
# Ω  = 125.04 -  0.052954 * (MJD - 51544.5) = Mean longitude of the ascending node of the moon
#
# UT1-UT1R = Σ Ai*sin(ξi)
# where ξi = a1*l + a2*l' + a3*D + a4*F + a5*Ω
#
# Note: This program prints the negative of the above result
#   e.g. DUT1R = UT1R-UT1

LM=$(echo "(134.960 + 13.0649930 * ($MJD - 51544.50)) % 360" | bc) # l
LS=$(echo "(357.530 +  0.9856000 * ($MJD - 51544.50)) % 360" | bc) # l'
FM=$(echo "( 93.270 + 13.2293500 * ($MJD - 51544.50)) % 360" | bc) # F
DS=$(echo "(297.850 + 12.1907490 * ($MJD - 51544.50)) % 360" | bc) # D
OM=$(echo "(125.040 -  0.0529540 * ($MJD - 51544.50)) % 360" | bc) # Ω

datatable=$(grep "^#% " "$0" | sed -e "s/ \+/ /g")
Pi="3.14159265358979323846264338"
Si="0"
[ -z "$NUMTERMS" ] && NUMTERMS="62"
for i in $(seq 1 $NUMTERMS); do
	line=$(echo "$datatable" | grep "^#% $i ")
	LMX=$(echo "$line" | cut -d' ' -f3)
	LSX=$(echo "$line" | cut -d' ' -f4)
	FMX=$(echo "$line" | cut -d' ' -f5)
	DSX=$(echo "$line" | cut -d' ' -f6)
	OMX=$(echo "$line" | cut -d' ' -f7)
	Ai=$(echo  "$line" | cut -d' ' -f8)
	Xi=$(echo "($LMX*$LM + $LSX*$LS + $FMX*$FM + $DSX*$DS + $OMX*$OM) % 360" | bc)
	Ri=$(echo "$Ai * s($Xi*$Pi/180)" | bc -l)
	Si="$Si + $Ri"
done
ut1r_ut1=$(echo "($Si) * -0.0001" | bc)

[ -z "$PRECISION" ] && PRECISION="9"
[ -n "$SHOWDEFN" ] && printf "%s" "UT1R-UT1="
printf "%0.${PRECISION}f\n" "$ut1r_ut1"

